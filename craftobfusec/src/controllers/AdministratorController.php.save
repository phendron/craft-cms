<?php

namespace developer\testplugin\controllers;

use yii\web\Response;
use Craft;
use craft\web\view;
use craft\web\Controller;
use developer\testplugin\TestpluginBundle;

class AdministratorController extends Controller {

//protected $allowAnonymous = ['missing','login'];
protected $allowAnonymous = true;

public function actionLogin(){
//$this->view->registerAssetBundle(TestpluginBundle::class, 1);
return $this->renderTemplate('test-plugin/login.twig', []);
}

public function actionMissing(){
//$this->view->registerAssetBundle(TestPluginBundle::class);
return $this->renderTemplate('test-plugin/missing.twig', []);
}


public function actionUsernameauthenticate(){

$default_data = ['CRAFT_CSRF_TOKEN','action','redirect','username'];
$recv_data = (object) [$default_data[0] => '', $default_data[1] => '', $default_data[2] => '', $default_data[3] => ''];
for($i=0; $i < count($default_data); $i++){
$param = Craft::$app->request->getBodyParam($default_data[$i]);

if($param == true){
$recv_data->{$default_data[$i]}=$param;
} else {

$data = (object) ['error'=>(object)['username'=>false]];
echo json_encode($data);
exit(0);
}

}


$user = \craft\elements\User::find()->username(\craft\helpers\Db::escapeParam($recv_data->username))->one();

if($user){
$data = (object) ['error'=>(object)['username'=>false],'redirect'=>'authenticate_method'];
echo json_encode($data);
exit(0);
} else {
$data = (object) ['error'=>(object)['username'=>true]];
echo json_encode($data);
exit(0);
}
}

}

?>

