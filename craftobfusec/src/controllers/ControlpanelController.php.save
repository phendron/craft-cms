<?php

namespace developer\testplugin\controllers;

use yii\web\Response;
use Craft;
use craft\web\view;
use craft\web\Controller;
use developer\testplugin\TestpluginBundle;
use developer\testplugin\TestPlugin;

class ControlpanelController extends Controller {

protected $allowAnonymous = true;

public function actionInit(){
//return $this->renderTemplate("test-plugin/controlpanel/index.twig", ['settings'=>Craft::$app->getPlugins()->getPlugin('test-plugin')::getInstance()->SettingsQuery->getSettings()]);

$save_request=false;
$save_error=false;
if(Craft::$app->request->getBodyParam('action_request')){
$save_request=true;
$update_row = array(
    'secure_route'=>Craft::$app->request->getBodyParam('secure_route'),
    'global_default_route'=>Craft::$app->request->getBodyParam('global_default_route'),
    'unique_urls_active'=>Craft::$app->request->getBodyParam('unique_urls_active')
);


$updated = TestPlugin::getInstance()->settingsquery->updateSettings($update_row);
if(!$updated){
$save_error=true;
}
}


$parameters = TestPlugin::getInstance()->settingsquery->getSettings();
$parameters["authorized_users"] = TestPlugin::getInstance()->pathbrowserquery->getAuthenticatedUsersCount();
$parameters["save_request"]=$save_request;
$parameters["save_error"]=$save_error;
return $this->renderTemplate("test-plugin/controlpanel/index.twig", ['settings'=>$parameters]);
}


public function actionPathbrowser(){
$parameters["users"] = TestPlugin::getInstance()->pathbrowserquery->getAuthenticatedUsers(10);
$parameters["count"] = TestPlugin::getInstance()->pathbrowserquery->getAuthenticatedUsersCount();
return $this->renderTemplate("test-plugin/controlpanel/path-browser.twig", ["data"=>$parameters]);
}


public function actionInitializeuser(){

if(Craft::$app->request->getBodyParam("CRAFT_CSRF_TOKEN")){
$user_id = Craft::$app->request->getBodyParam("user_id");
$initialized=TestPlugin::getInstance()->pathbrowserquery->AuthenticateUserById($user_id);

if($initialized){
$data = array("success"=>true);
echo json_encode($data);
exit(0);
} else {
$data = array("success"=>false);
echo json_encode($data);
exit(0);
}
} else {
exit(0);
}
}



public function actionReinitializeuser(){

if(Craft::$app->request->getBodyParam("CRAFT_CSRF_TOKEN")){
$user_id = Craft::$app->request->getBodyParam("user_uid");
$initialized=TestPlugin::getInstance()->pathbrowserquery->ReAuthenticateUserByUid($user_uid);

if($initialized){
$data = array("success"=>true);
echo json_encode($data);
exit(0);
} else {
$data = array("success"=>false);
echo json_encode($data);
exit(0);
}
} else {
exit(0);
}
}


public function actionUninitializedusers(){
$users=TestPlugin::getInstance()->pathbrowserquery->getUnauthenticatedUserIds();
echo json_encode(array("users"=>$users,"CRAFT_CSRF_TOKEN"=>Craft::$app->request->getCsrfToken()));
//echo json_encode(["success"=>"true"]);
exit(0);
}



public function actionSaveSettings(){

}

}



?>
